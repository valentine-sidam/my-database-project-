// Firebase Configuration ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore
// ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö Firebase JS SDK v9+

import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { 
    getFirestore, 
    collection, 
    getDocs, 
    addDoc, 
    updateDoc, 
    doc, 
    query, 
    where, 
    orderBy, 
    limit,
    onSnapshot
} from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

// Firebase Web Config - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Admin SDK ‡πÅ‡∏•‡∏∞ Firebase standards
// ‚úÖ ‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å Project ID: my-database-project-343ae
const firebaseConfig = {
    apiKey: "AIzaSyDxvNhL4N8mF9YrKfXvZ5LxGYK-5qE8cVQ", // ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Firebase Console
    authDomain: "my-database-project-343ae.firebaseapp.com",
    projectId: "my-database-project-343ae",
    storageBucket: "my-database-project-343ae.appspot.com",
    messagingSenderId: "111449885278684667388", // ‡∏à‡∏≤‡∏Å Admin SDK client_id
    appId: "1:111449885278684667388:web:toolbase2024app" // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡∏≤‡∏° pattern
};

// Initialize Firebase
let app, db;

try {
    console.log('üî• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
    console.log('üìä Project ID:', firebaseConfig.projectId);
    
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    
    console.log('‚úÖ Firebase initialized successfully');
    console.log('üåê Auth Domain:', firebaseConfig.authDomain);
    
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢
    console.log('üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firestore...');
    
} catch (error) {
    console.error('‚ùå Firebase initialization failed:', error);
    console.error('üí° ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Config ‡πÉ‡∏ô FIREBASE_CONFIG_GUIDE.md');
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    if (typeof alert !== 'undefined') {
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏î‡πâ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n1. Firebase Web Config ‡πÉ‡∏ô firebase-real-config.js\n2. ‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô FIREBASE_CONFIG_GUIDE.md\n\nError: ${error.message}`);
    }
}

// Firebase Database Functions
class FirebaseService {
    constructor() {
        this.db = db;
        this.collections = {
            employees: 'employees',
            tools: 'tools',
            toolRequests: 'tool_requests',
            toolStatus: 'tool_status', 
            approvals: 'approvals',
            approvalHistory: 'approval_history',
            borrowHistory: 'borrow_history',
            transactions: 'transactions'
        };
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async getEmployees() {
        try {
            const querySnapshot = await getDocs(collection(this.db, this.collections.employees));
            const employees = [];
            querySnapshot.forEach((doc) => {
                employees.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', employees.length, '‡∏Ñ‡∏ô');
            return employees;
        } catch (error) {
            console.error('‚ùå Error fetching employees:', error);
            return [];
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    async getTools() {
        try {
            const querySnapshot = await getDocs(collection(this.db, this.collections.tools));
            const tools = [];
            querySnapshot.forEach((doc) => {
                tools.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:', tools.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            return tools;
        } catch (error) {
            console.error('‚ùå Error fetching tools:', error);
            return [];
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
    async getToolRequests(employeeId = null) {
        try {
            let q = collection(this.db, this.collections.toolRequests);
            
            if (employeeId) {
                q = query(q, where("employee_id", "==", employeeId));
            }
            
            q = query(q, orderBy("created_at", "desc"));
            
            const querySnapshot = await getDocs(q);
            const requests = [];
            querySnapshot.forEach((doc) => {
                requests.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠:', requests.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            return requests;
        } catch (error) {
            console.error('‚ùå Error fetching tool requests:', error);
            return [];
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
    async getToolStatus() {
        try {
            const querySnapshot = await getDocs(collection(this.db, this.collections.toolStatus));
            const status = [];
            querySnapshot.forEach((doc) => {
                status.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:', status.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            return status;
        } catch (error) {
            console.error('‚ùå Error fetching tool status:', error);
            return [];
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
    async getApprovals() {
        try {
            const querySnapshot = await getDocs(collection(this.db, this.collections.approvals));
            const approvals = [];
            querySnapshot.forEach((doc) => {
                approvals.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            console.log('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:', approvals.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            return approvals;
        } catch (error) {
            console.error('‚ùå Error fetching approvals:', error);
            return [];
        }
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà
    async addToolRequest(requestData) {
        try {
            const docRef = await addDoc(collection(this.db, this.collections.toolRequests), {
                ...requestData,
                created_at: new Date(),
                status: 'pending'
            });
            console.log('‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà ID:', docRef.id);
            return docRef.id;
        } catch (error) {
            console.error('‚ùå Error adding tool request:', error);
            throw error;
        }
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠
    async updateRequestStatus(requestId, status, updatedBy = null) {
        try {
            const updateData = {
                status: status,
                updated_at: new Date()
            };
            
            if (updatedBy) {
                updateData.updated_by = updatedBy;
            }
            
            await updateDoc(doc(this.db, this.collections.toolRequests, requestId), updateData);
            console.log('‚úÖ ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏≥‡∏Ç‡∏≠:', requestId, '‡πÄ‡∏õ‡πá‡∏ô', status);
            return true;
        } catch (error) {
            console.error('‚ùå Error updating request status:', error);
            throw error;
        }
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å Employee ID
    async getEmployeeById(employeeId) {
        try {
            const q = query(
                collection(this.db, this.collections.employees), 
                where("employee_id", "==", employeeId)
            );
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
                return null;
            }
            
            const doc = querySnapshot.docs[0];
            return {
                id: doc.id,
                ...doc.data()
            };
        } catch (error) {
            console.error('‚ùå Error fetching employee by ID:', error);
            return null;
        }
    }

    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
    async testConnection() {
        try {
            console.log('üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 1 record ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞ collection
            const tests = [];
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö employees
            try {
                const empQuery = query(collection(this.db, this.collections.employees), limit(1));
                const empSnapshot = await getDocs(empQuery);
                tests.push({
                    collection: 'employees',
                    status: empSnapshot.size > 0 ? '‚úÖ' : '‚ö†Ô∏è',
                    count: empSnapshot.size,
                    message: empSnapshot.size > 0 ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                });
            } catch (error) {
                tests.push({
                    collection: 'employees',
                    status: '‚ùå',
                    count: 0,
                    message: 'Collection ‡πÑ‡∏°‡πà‡∏û‡∏ö'
                });
            }

            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö tools
            try {
                const toolsQuery = query(collection(this.db, this.collections.tools), limit(1));
                const toolsSnapshot = await getDocs(toolsQuery);
                tests.push({
                    collection: 'tools',
                    status: toolsSnapshot.size > 0 ? '‚úÖ' : '‚ö†Ô∏è',
                    count: toolsSnapshot.size,
                    message: toolsSnapshot.size > 0 ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                });
            } catch (error) {
                tests.push({
                    collection: 'tools',
                    status: '‚ùå',
                    count: 0,
                    message: 'Collection ‡πÑ‡∏°‡πà‡∏û‡∏ö'
                });
            }

            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö tool_requests
            try {
                const reqQuery = query(collection(this.db, this.collections.toolRequests), limit(1));
                const reqSnapshot = await getDocs(reqQuery);
                tests.push({
                    collection: 'tool_requests',
                    status: reqSnapshot.size > 0 ? '‚úÖ' : '‚ö†Ô∏è',
                    count: reqSnapshot.size,
                    message: reqSnapshot.size > 0 ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'
                });
            } catch (error) {
                tests.push({
                    collection: 'tool_requests',
                    status: '‚ùå',
                    count: 0,
                    message: 'Collection ‡πÑ‡∏°‡πà‡∏û‡∏ö'
                });
            }

            console.log('üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:');
            tests.forEach(test => {
                console.log(`${test.status} ${test.collection}: ${test.message}`);
            });

            return tests;
        } catch (error) {
            console.error('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
            return [];
        }
    }

    // ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Ç‡∏≠‡∏á Database
    async getDatabaseStats() {
        try {
            const stats = {};
            
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ collection
            for (const [key, collectionName] of Object.entries(this.collections)) {
                try {
                    const snapshot = await getDocs(collection(this.db, collectionName));
                    stats[key] = snapshot.size;
                } catch (error) {
                    stats[key] = 0;
                }
            }
            
            console.log('üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Database:', stats);
            return stats;
        } catch (error) {
            console.error('‚ùå Error getting database stats:', error);
            return {};
        }
    }
    listenToCollection(collectionName, callback) {
        return onSnapshot(collection(this.db, collectionName), (snapshot) => {
            const data = [];
            snapshot.forEach((doc) => {
                data.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            callback(data);
        });
    }
}

// Export Firebase Service
window.FirebaseService = FirebaseService;
window.firebaseApp = app;
window.firebaseDb = db;

// ‡∏™‡∏£‡πâ‡∏≤‡∏á instance ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
window.firebase = new FirebaseService();

console.log('üî• Firebase Service ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!');