<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools Track - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Firebase)</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f3e8;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 3px solid #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            color: #666;
            font-size: 18px;
        }

        .firebase-notice {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .firebase-notice h3 {
            color: #0c5460;
            margin-bottom: 5px;
        }

        .firebase-notice p {
            color: #0c5460;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .search-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #4A90E2;
        }

        .search-title {
            color: #4A90E2;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #4A90E2;
            padding-bottom: 5px;
        }

        .search-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: bold;
            color: #4A90E2;
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #4A90E2;
            border-radius: 8px;
            font-size: 14px;
        }

        .btn-filter {
            padding: 10px 20px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            height: fit-content;
        }

        .btn-filter:hover {
            background: #357abd;
        }

        .requests-table {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #4A90E2;
        }

        .table-header {
            color: #4A90E2;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            border-bottom: 2px solid #4A90E2;
            padding-bottom: 5px;
        }

        .table-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .request-item {
            background: #fafafa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .request-id {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }

        .request-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
            border: 2px solid #99d6ff;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .request-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .request-info div {
            color: #555;
        }

        .tools-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .tools-list h4 {
            color: #4A90E2;
            margin-bottom: 10px;
        }

        .tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #ddd;
        }

        .tool-item:last-child {
            border-bottom: none;
        }

        .tool-name {
            font-weight: bold;
            color: #333;
        }

        .tool-quantity {
            color: #666;
            font-size: 14px;
        }

        .status-details {
            background: #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 14px;
        }

        .actions {
            text-align: center;
            margin-top: 30px;
        }

        .btn-new-request {
            display: inline-block;
            padding: 15px 30px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-new-request:hover {
            background: #218838;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #4A90E2;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #4A90E2;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            .search-form {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .request-info {
                grid-template-columns: 1fr;
            }

            .stats-section {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ†Ô∏è Tools Track</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ (Firebase)</p>
        </div>

        <div class="firebase-notice">
            <h3>üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase</h3>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏≤‡∏Å Firebase Database ‡πÅ‡∏ö‡∏ö Real-time</p>
        </div>

        <div id="loadingIndicator" class="loading">
            <div>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Statistics Section -->
            <div class="stats-section" id="statsSection">
                <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <div class="search-title">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="search-form">
                    <div class="form-group">
                        <label for="startDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                        <input type="date" id="startDate" name="startDate">
                    </div>
                    <div class="form-group">
                        <label for="endDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                        <input type="date" id="endDate" name="endDate">
                    </div>
                    <div class="form-group">
                        <label for="statusFilter">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
                        <select id="statusFilter" name="statusFilter">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                        </select>
                    </div>
                    <button class="btn-filter" onclick="filterRequests()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                </div>
            </div>

            <!-- Requests Table -->
            <div class="requests-table">
                <div class="table-header">
                    üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
                </div>
                <div class="table-content" id="requestsContainer">
                    <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                </div>
            </div>

            <!-- Actions -->
            <div class="actions">
                <a href="tools-request-firebase.html" class="btn-new-request">
                    ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏´‡∏°‡πà
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="firebase-real-config.js"></script>
    
    <script type="module">
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let allRequests = [];
        let filteredRequests = [];

        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        window.addEventListener('load', async () => {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠');
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase Service ‡∏û‡∏£‡πâ‡∏≠‡∏°
            await waitForFirebase();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
            await loadData();
        });

        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebase) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        async function loadData() {
            try {
                document.getElementById('loadingIndicator').innerHTML = '<div>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠...</div>';
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                allRequests = await window.firebase.getToolRequests();
                filteredRequests = [...allRequests];
                
                console.log('üìã ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:', allRequests.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');

                // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (30 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)
                setDefaultDateRange();

                // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                displayStats();

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠
                displayRequests(filteredRequests);

                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div style="color: red;">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
                    </div>
                `;
            }
        }

        function setDefaultDateRange() {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            document.getElementById('startDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }

        function displayStats() {
            const stats = {
                total: allRequests.length,
                pending: allRequests.filter(req => req.status === 'pending').length,
                approved: allRequests.filter(req => req.status === 'approved').length,
                completed: allRequests.filter(req => req.status === 'completed').length,
                rejected: allRequests.filter(req => req.status === 'rejected').length
            };

            document.getElementById('statsSection').innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #856404;">${stats.pending}</div>
                    <div class="stat-label">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #155724;">${stats.approved}</div>
                    <div class="stat-label">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #004085;">${stats.completed}</div>
                    <div class="stat-label">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #721c24;">${stats.rejected}</div>
                    <div class="stat-label">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</div>
                </div>
            `;
        }

        function displayRequests(requests) {
            const container = document.getElementById('requestsContainer');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        üì≠ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="request-item">
                    <div class="request-header">
                        <div class="request-id">üìã ${request.id}</div>
                        <div class="request-status ${getStatusClass(request.status)}">
                            ${getStatusText(request.status)}
                        </div>
                    </div>
                    
                    <div class="request-info">
                        <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠:</strong> ${formatDate(request.created_at)}</div>
                        <div><strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</strong> ${request.employee_name} (${request.employee_id})</div>
                        <div><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${request.department || '-'}</div>
                        <div><strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${request.section || '-'}</div>
                        <div><strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> ${request.project || '-'}</div>
                    </div>

                    ${getStatusDetails(request)}
                    
                    <div class="tools-list">
                        <h4>üîß ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</h4>
                        ${request.requested_tools ? request.requested_tools.map(tool => `
                            <div class="tool-item">
                                <span class="tool-name">${tool.tool_code || tool.tool_id} - ${tool.tool_name}</span>
                                <span class="tool-quantity">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${tool.quantity}</span>
                            </div>
                            ${tool.note ? `<div style="font-size: 12px; color: #666; margin-left: 10px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${tool.note}</div>` : ''}
                        `).join('') : '<div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</div>'}
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            const statusClasses = {
                'pending': 'status-pending',
                'approved': 'status-approved', 
                'completed': 'status-completed',
                'rejected': 'status-rejected'
            };
            return statusClasses[status] || 'status-pending';
        }

        function getStatusText(status) {
            const statusTexts = {
                'pending': '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                'approved': '‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
                'completed': 'üéØ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                'rejected': '‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'
            };
            return statusTexts[status] || '‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£';
        }

        function getStatusDetails(request) {
            let details = '';
            
            switch (request.status) {
                case 'approved':
                    details = `
                        <div class="status-details">
                            <strong>‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${request.approved_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥:</strong> ${formatDate(request.approved_at)}
                        </div>
                    `;
                    break;
                case 'completed':
                    details = `
                        <div class="status-details">
                            <strong>üéØ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${formatDate(request.completed_at)}<br>
                            <strong>‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢:</strong> ${request.approved_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </div>
                    `;
                    break;
                case 'rejected':
                    details = `
                        <div class="status-details">
                            <strong>‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡πÇ‡∏î‡∏¢:</strong> ${request.rejected_by || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}<br>
                            <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:</strong> ${formatDate(request.rejected_at)}<br>
                            <strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${request.rejected_reason || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </div>
                    `;
                    break;
            }
            
            return details;
        }

        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            
            try {
                let date;
                if (dateString.toDate) {
                    // Firestore Timestamp
                    date = dateString.toDate();
                } else {
                    // ISO String
                    date = new Date(dateString);
                }
                
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        window.filterRequests = function() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const status = document.getElementById('statusFilter').value;

            filteredRequests = allRequests.filter(request => {
                let dateMatch = true;
                let statusMatch = true;

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                if (startDate || endDate) {
                    let requestDate;
                    if (request.created_at && request.created_at.toDate) {
                        requestDate = request.created_at.toDate();
                    } else if (request.created_at) {
                        requestDate = new Date(request.created_at);
                    } else {
                        dateMatch = false;
                    }

                    if (dateMatch && startDate) {
                        dateMatch = dateMatch && requestDate >= new Date(startDate);
                    }
                    if (dateMatch && endDate) {
                        dateMatch = dateMatch && requestDate <= new Date(endDate + 'T23:59:59');
                    }
                }

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                if (status) {
                    statusMatch = request.status === status;
                }

                return dateMatch && statusMatch;
            });

            console.log('üîç ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', filteredRequests.length, '‡∏à‡∏≤‡∏Å', allRequests.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
            displayRequests(filteredRequests);
        };

        // Real-time listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        if (window.firebase) {
            window.firebase.listenToCollection('tool_requests', (newData) => {
                console.log('üî• ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≤‡∏Å Firebase:', newData.length, '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                allRequests = newData;
                filteredRequests = [...allRequests];
                displayStats();
                filterRequests(); // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            });
        }

    </script>
</body>
</html>