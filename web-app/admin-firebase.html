<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Management - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Firebase)</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f0f0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #f5f3e8;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border: 3px solid #333;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            color: #333;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header p {
            color: #666;
            font-size: 18px;
        }

        .firebase-notice {
            background: #d1ecf1;
            border: 2px solid #bee5eb;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .firebase-notice h3 {
            color: #0c5460;
            margin-bottom: 5px;
        }

        .firebase-notice p {
            color: #0c5460;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #4A90E2;
            text-align: center;
        }

        .dashboard-card h3 {
            color: #4A90E2;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .dashboard-number {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .dashboard-label {
            color: #666;
            font-size: 14px;
        }

        .tabs-container {
            background: white;
            border-radius: 15px;
            border: 2px solid #4A90E2;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: #4A90E2;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }

        .tab-button.active {
            background: white;
            color: #4A90E2;
        }

        .tab-button:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }

        .tab-content {
            padding: 25px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: bold;
            color: #333;
            position: sticky;
            top: 0;
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-completed {
            background: #cce5ff;
            color: #004085;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
        }

        .btn-approve {
            background: #28a745;
            color: white;
        }

        .btn-reject {
            background: #dc3545;
            color: white;
        }

        .btn-complete {
            background: #007bff;
            color: white;
        }

        .btn-view {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            padding: 8px 12px;
            border: 2px solid #4A90E2;
            border-radius: 5px;
            font-size: 14px;
        }

        .search-filter button {
            padding: 8px 16px;
            background: #4A90E2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #4A90E2;
        }

        .modal-header h3 {
            color: #4A90E2;
            margin: 0;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            text-align: right;
        }

        .modal-footer button {
            margin-left: 10px;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background: #4A90E2;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .tabs-header {
                flex-direction: column;
            }

            .search-filter {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Admin Management</h1>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Firebase)</p>
        </div>

        <div class="firebase-notice">
            <h3>üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase</h3>
            <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å Firebase Database ‡πÅ‡∏ö‡∏ö Real-time</p>
        </div>

        <div id="loadingIndicator" class="loading">
            <div>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase...</div>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Dashboard Cards -->
            <div class="dashboard-grid" id="dashboardStats">
                <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>

            <!-- Tabs Container -->
            <div class="tabs-container">
                <div class="tabs-header">
                    <button class="tab-button active" onclick="showTab('requests')">üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠</button>
                    <button class="tab-button" onclick="showTab('employees')">üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</button>
                    <button class="tab-button" onclick="showTab('tools')">üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</button>
                    <button class="tab-button" onclick="showTab('reports')">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>

                <!-- Requests Management Tab -->
                <div id="requestsTab" class="tab-content active">
                    <h3>üìã ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
                    
                    <div class="search-filter">
                        <input type="text" id="requestSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏≥‡∏Ç‡∏≠...">
                        <select id="requestStatusFilter">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="pending">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
                            <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
                            <option value="rejected">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</option>
                        </select>
                        <button onclick="filterRequests()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
                                    <th>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Employees Management Tab -->
                <div id="employeesTab" class="tab-content">
                    <h3>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                    
                    <div class="search-filter">
                        <input type="text" id="employeeSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...">
                        <select id="departmentFilter">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>
                        </select>
                        <button onclick="filterEmployees()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
                                    <th>‡πÅ‡∏ú‡∏ô‡∏Å</th>
                                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th>‡∏Å‡∏•‡∏∏‡πà‡∏°</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tools Management Tab -->
                <div id="toolsTab" class="tab-content">
                    <h3>üîß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
                    
                    <div class="search-filter">
                        <input type="text" id="toolSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠...">
                        <select id="toolStatusFilter">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                            <option value="available">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                            <option value="in_use">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                            <option value="maintenance">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</option>
                            <option value="damaged">‡∏ä‡∏≥‡∏£‡∏∏‡∏î</option>
                        </select>
                        <button onclick="filterTools()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                                    <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</th>
                                    <th>Serial No.</th>
                                    <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                    <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="toolsTableBody">
                                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reportsTab" class="tab-content">
                    <h3>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</h3>
                    
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</h3>
                            <div id="toolUsageStats">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>üë• ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
                            <div id="employeeStats">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        </div>
                        <div class="dashboard-card">
                            <h3>‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</h3>
                            <div id="approvalTimeStats">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div id="requestModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠</h3>
            </div>
            <div id="requestModalBody">
                <!-- ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">‡∏õ‡∏¥‡∏î</button>
                <button class="btn-primary" onclick="updateRequestStatus()">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module" src="firebase-real-config.js"></script>
    
    <script type="module">
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        let allRequests = [];
        let allEmployees = [];
        let allTools = [];
        let currentRequest = null;

        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        window.addEventListener('load', async () => {
            console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Admin Management');
            
            // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Firebase Service ‡∏û‡∏£‡πâ‡∏≠‡∏°
            await waitForFirebase();
            
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase
            await loadAllData();
        });

        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebase) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        async function loadAllData() {
            try {
                document.getElementById('loadingIndicator').innerHTML = '<div>üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Firebase...</div>';
                
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                const [requests, employees, tools] = await Promise.all([
                    window.firebase.getToolRequests(),
                    window.firebase.getEmployees(),
                    window.firebase.getTools()
                ]);

                allRequests = requests;
                allEmployees = employees;
                allTools = tools;
                
                console.log('üìã ‡∏Ñ‡∏≥‡∏Ç‡∏≠:', allRequests.length);
                console.log('üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:', allEmployees.length);
                console.log('üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:', allTools.length);

                // ‡∏ã‡πà‡∏≠‡∏ô loading ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                updateDashboardStats();
                displayRequests();
                displayEmployees();
                displayTools();
                updateReports();

                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô');

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div style="color: red;">
                        ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>
                        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase
                    </div>
                `;
            }
        }

        function updateDashboardStats() {
            const stats = {
                totalRequests: allRequests.length,
                pendingRequests: allRequests.filter(req => req.status === 'pending').length,
                totalEmployees: allEmployees.length,
                totalTools: allTools.length,
                availableTools: allTools.filter(tool => tool.status === 'available').length
            };

            document.getElementById('dashboardStats').innerHTML = `
                <div class="dashboard-card">
                    <h3>üìã ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="dashboard-number">${stats.totalRequests}</div>
                    <div class="dashboard-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="dashboard-card">
                    <h3>‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                    <div class="dashboard-number" style="color: #856404;">${stats.pendingRequests}</div>
                    <div class="dashboard-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="dashboard-card">
                    <h3>üë• ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="dashboard-number">${stats.totalEmployees}</div>
                    <div class="dashboard-label">‡∏Ñ‡∏ô</div>
                </div>
                <div class="dashboard-card">
                    <h3>üîß ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                    <div class="dashboard-number">${stats.totalTools}</div>
                    <div class="dashboard-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
                <div class="dashboard-card">
                    <h3>‚úÖ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ</h3>
                    <div class="dashboard-number" style="color: #155724;">${stats.availableTools}</div>
                    <div class="dashboard-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
                </div>
            `;
        }

        function displayRequests() {
            const tbody = document.getElementById('requestsTableBody');
            
            tbody.innerHTML = allRequests.map(request => `
                <tr>
                    <td>${request.id}</td>
                    <td>${formatDate(request.created_at)}</td>
                    <td>${request.employee_name}<br><small>${request.employee_id}</small></td>
                    <td>${request.department || '-'}<br><small>${request.section || '-'}</small></td>
                    <td>
                        ${request.requested_tools ? request.requested_tools.length : 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        <br><small>${request.requested_tools ? request.requested_tools.map(t => t.tool_name).slice(0,2).join(', ') : ''}</small>
                    </td>
                    <td><span class="status-badge status-${request.status}">${getStatusText(request.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewRequest('${request.id}')">üëÅÔ∏è ‡∏î‡∏π</button>
                            ${request.status === 'pending' ? `
                                <button class="btn btn-approve" onclick="approveRequest('${request.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                <button class="btn btn-reject" onclick="rejectRequest('${request.id}')">‚ùå ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                            ` : ''}
                            ${request.status === 'approved' ? `
                                <button class="btn btn-complete" onclick="completeRequest('${request.id}')">üéØ ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function displayEmployees() {
            const tbody = document.getElementById('employeesTableBody');
            
            tbody.innerHTML = allEmployees.map(employee => `
                <tr>
                    <td>${employee.employee_id}</td>
                    <td>${employee.full_name}</td>
                    <td>${employee.department || '-'}</td>
                    <td>${employee.section || '-'}</td>
                    <td>${employee.position || '-'}</td>
                    <td>${employee.group || '-'}</td>
                </tr>
            `).join('');

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô
            const departments = [...new Set(allEmployees.map(emp => emp.department).filter(Boolean))];
            const departmentFilter = document.getElementById('departmentFilter');
            departmentFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</option>' +
                departments.map(dept => `<option value="${dept}">${dept}</option>`).join('');
        }

        function displayTools() {
            const tbody = document.getElementById('toolsTableBody');
            
            tbody.innerHTML = allTools.map(tool => `
                <tr>
                    <td>${tool.old_code || tool.id}</td>
                    <td>${tool.tool_name}</td>
                    <td>${tool.serial_no || '-'}</td>
                    <td>${tool.location || '-'}</td>
                    <td><span class="status-badge status-${tool.status || 'available'}">${getToolStatusText(tool.status)}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view" onclick="viewTool('${tool.id}')">üëÅÔ∏è ‡∏î‡∏π</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateReports() {
            // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠
            const toolUsage = allRequests.reduce((acc, req) => {
                if (req.requested_tools) {
                    req.requested_tools.forEach(tool => {
                        acc[tool.tool_name] = (acc[tool.tool_name] || 0) + tool.quantity;
                    });
                }
                return acc;
            }, {});

            const topTools = Object.entries(toolUsage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            document.getElementById('toolUsageStats').innerHTML = topTools.length > 0 
                ? topTools.map(([name, count]) => `<div>${name}: ${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div>`).join('')
                : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';

            // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
            const employeesByDept = allEmployees.reduce((acc, emp) => {
                const dept = emp.department || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                acc[dept] = (acc[dept] || 0) + 1;
                return acc;
            }, {});

            document.getElementById('employeeStats').innerHTML = Object.entries(employeesByDept)
                .map(([dept, count]) => `<div>${dept}: ${count} ‡∏Ñ‡∏ô</div>`)
                .join('');

            // ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
            const approvedRequests = allRequests.filter(req => req.approved_at && req.created_at);
            let avgTime = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            
            if (approvedRequests.length > 0) {
                const totalTime = approvedRequests.reduce((acc, req) => {
                    const created = req.created_at.toDate ? req.created_at.toDate() : new Date(req.created_at);
                    const approved = req.approved_at.toDate ? req.approved_at.toDate() : new Date(req.approved_at);
                    return acc + (approved - created);
                }, 0);
                
                const avgMs = totalTime / approvedRequests.length;
                const avgDays = Math.round(avgMs / (1000 * 60 * 60 * 24));
                avgTime = `${avgDays} ‡∏ß‡∏±‡∏ô`;
            }

            document.getElementById('approvalTimeStats').innerHTML = avgTime;
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ
        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            
            try {
                let date;
                if (dateString.toDate) {
                    date = dateString.toDate();
                } else {
                    date = new Date(dateString);
                }
                
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString;
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'pending': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                'approved': '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß',
                'completed': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                'rejected': '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò'
            };
            return statusTexts[status] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
        }

        function getToolStatusText(status) {
            const statusTexts = {
                'available': '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                'in_use': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô',
                'maintenance': '‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á',
                'damaged': '‡∏ä‡∏≥‡∏£‡∏∏‡∏î'
            };
            return statusTexts[status] || '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tabs
        window.showTab = function(tabName) {
            // ‡∏ã‡πà‡∏≠‡∏ô tab ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // ‡πÅ‡∏™‡∏î‡∏á tab ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠
        window.viewRequest = function(requestId) {
            const request = allRequests.find(req => req.id === requestId);
            if (!request) return;

            currentRequest = request;
            
            document.getElementById('requestModalBody').innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>‡∏£‡∏´‡∏±‡∏™‡∏Ñ‡∏≥‡∏Ç‡∏≠:</strong> ${request.id}<br>
                    <strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠:</strong> ${formatDate(request.created_at)}<br>
                    <strong>‡∏ú‡∏π‡πâ‡∏Ç‡∏≠:</strong> ${request.employee_name} (${request.employee_id})<br>
                    <strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> ${request.department || '-'}<br>
                    <strong>‡πÅ‡∏ú‡∏ô‡∏Å:</strong> ${request.section || '-'}<br>
                    <strong>‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</strong> ${request.project || '-'}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠:</strong>
                    ${request.requested_tools ? request.requested_tools.map(tool => `
                        <div style="padding: 8px; border: 1px solid #ddd; margin: 5px 0; border-radius: 5px;">
                            <strong>${tool.tool_name}</strong><br>
                            ‡∏£‡∏´‡∏±‡∏™: ${tool.tool_code || '-'} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${tool.quantity}<br>
                            ${tool.note ? `‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${tool.note}` : ''}
                        </div>
                    `).join('') : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠'}
                </div>
                
                <div>
                    <strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</strong> 
                    <span class="status-badge status-${request.status}">${getStatusText(request.status)}</span>
                </div>
            `;
            
            document.getElementById('requestModal').style.display = 'block';
        };

        window.approveRequest = async function(requestId) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ?')) {
                try {
                    await window.firebase.updateRequestStatus(requestId, 'approved', 'Admin');
                    alert('‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    await loadAllData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        };

        window.rejectRequest = async function(requestId) {
            const reason = prompt('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò:');
            if (reason) {
                try {
                    await window.firebase.updateRequestStatus(requestId, 'rejected', 'Admin');
                    alert('‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    await loadAllData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        };

        window.completeRequest = async function(requestId) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"?')) {
                try {
                    await window.firebase.updateRequestStatus(requestId, 'completed', 'Admin');
                    alert('‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                    await loadAllData(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                }
            }
        };

        window.closeModal = function() {
            document.getElementById('requestModal').style.display = 'none';
            currentRequest = null;
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        window.filterRequests = function() {
            // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            console.log('‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠');
        };

        window.filterEmployees = function() {
            // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            console.log('‡∏Å‡∏£‡∏≠‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
        };

        window.filterTools = function() {
            // ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
            console.log('‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠');
        };

        // Real-time listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
        if (window.firebase) {
            window.firebase.listenToCollection('tool_requests', (newData) => {
                allRequests = newData;
                updateDashboardStats();
                displayRequests();
                updateReports();
            });
        }

    </script>
</body>
</html>